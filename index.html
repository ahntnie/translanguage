<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Text Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            text-align: center;
        }

        #transcript {
            font-size: 24px;
            color: #333;
            margin-top: 20px;
        }

        button {
            font-size: 16px;
            padding: 20px 40px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            position: relative;
            transition: all 0.3s;
        }

        button.recording {
            background-color: #f44336;
            /* Đổi màu khi thu âm */
        }

        #status {
            font-size: 18px;
            margin-top: 10px;
            color: #f44336;
        }
    </style>
</head>

<body>

    <h1>Chuyển Giọng Nói Thành Văn Bản</h1>
    <p>Nhấn nút để bắt đầu thu giọng nói hoặc dừng thu âm!</p>
    <button id="recordButton" onclick="toggleRecognition()">Bắt Đầu Thu Giọng Nói</button>

    <!-- Chỉ báo trạng thái -->
    <div id="status"></div>

    <!-- Văn bản sẽ hiển thị khi nhận diện xong -->
    <div id="transcript">Văn bản sẽ xuất hiện tại đây...</div>

    <script>
        let recognition;
        let isRecording = false;
        let noSpeechTimeout; // Timeout để kiểm tra không có âm thanh sau 3 giây
        let silenceTimeout; // Timeout để kiểm tra khi ngừng nói trong 2 giây

        // Hàm toggle thu âm (Bắt đầu hoặc dừng thu âm)
        function toggleRecognition() {
            if (isRecording) {
                stopRecognition();  // Nếu đang thu âm, dừng thu âm
            } else {
                startRecognition(); // Nếu không, bắt đầu thu âm
            }
        }

        // Hàm bắt đầu thu âm
        function startRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'vi-VN'; // Ngôn ngữ Tiếng Việt
            recognition.continuous = true; // Nhận diện liên tục
            recognition.interimResults = true; // Kết quả tạm thời (trong khi đang nói)

            // Đánh dấu là đang thu âm
            isRecording = true;
            document.getElementById('recordButton').classList.add('recording'); // Đổi màu nút khi thu âm
            document.getElementById('status').innerText = "Đang thu âm..."; // Hiển thị trạng thái
            document.getElementById('transcript').innerText = "Đang nhận diện...";

            // Bắt đầu nhận diện
            recognition.start();

            recognition.onresult = function (event) {
                const transcript = event.results[event.results.length - 1][0].transcript;

                // Khi có kết quả nhận diện tạm thời
                if (event.results[event.results.length - 1].isFinal) {
                    document.getElementById('transcript').innerText = transcript;
                    resetSilenceTimeout(); // Reset timeout khi có kết quả nhận diện

                    // Khi ngừng nói khoảng 2 giây mới hiện văn bản
                    clearTimeout(silenceTimeout);
                    silenceTimeout = setTimeout(function () {
                        // Ngừng thu âm khi không có âm thanh trong 2 giây
                        stopRecognition();
                    }, 2000);
                } else {
                    document.getElementById('transcript').innerText = transcript;
                }

                resetNoSpeechTimeout(); // Reset lại thời gian không có âm thanh
            };

            recognition.onerror = function (event) {
                console.error("Lỗi: " + event.error);
                document.getElementById('transcript').innerText = "Đã xảy ra lỗi khi nhận diện giọng nói.";
                stopRecognition(); // Dừng nhận diện nếu có lỗi
            };

            recognition.onend = function () {
                // Khi thu âm kết thúc, nếu không có âm thanh trong 3 giây, tự động dừng và thông báo
                noSpeechTimeout = setTimeout(function () {
                    stopRecognition();
                    document.getElementById('transcript').innerText = "Không có âm thanh nào.";
                }, 3000); // Dừng thu âm sau 3 giây nếu không có âm thanh
            };
        }

        // Hàm dừng thu âm
        function stopRecognition() {
            isRecording = false;
            document.getElementById('recordButton').classList.remove('recording'); // Quay lại màu ban đầu
            document.getElementById('status').innerText = ""; // Xóa trạng thái
            recognition.stop(); // Dừng nhận diện
            clearTimeout(noSpeechTimeout); // Xóa timeout nếu dừng thu âm thủ công
        }

        // Hàm reset timer khi có âm thanh
        function resetNoSpeechTimeout() {
            clearTimeout(noSpeechTimeout); // Xóa timeout cũ
            noSpeechTimeout = setTimeout(function () {
                stopRecognition();
                document.getElementById('transcript').innerText = "Không có âm thanh nào.";
            }, 3000); // Dừng thu âm sau 3s nếu không có âm thanh
        }

        // Hàm reset timer khi người dùng ngừng nói
        function resetSilenceTimeout() {
            clearTimeout(silenceTimeout); // Xóa timeout cũ
            silenceTimeout = setTimeout(function () {
                // Nếu không có âm thanh trong 2 giây thì ngừng thu âm và giữ văn bản
                stopRecognition();
            }, 2000); // Ngừng thu âm sau 2 giây không có âm thanh
        }
    </script>

</body>

</html>